<template>
  <view class="container">
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <view class="px-4 pt-10 pb-4 bg-white">
      <view class="flex items-center justify-between mb-4">
        <text class="text-xl font-bold">ç¯ä¿å…ˆé”‹</text>
        <view class="flex">
          <view class="mr-4">
            <icon-notification class="text-gray-500"></icon-notification>
          </view>
          <view>
            <icon-calendar class="text-gray-500"></icon-calendar>
          </view>
        </view>
      </view>

      <!-- æœç´¢æ¡† -->
      <view class="relative search-container">
        <view class="search-input-container">
          <input 
            type="text" 
            v-model="searchKeyword"
            class="search-bar w-full bg-gray-100 py-2 px-4 pr-10 text-sm" 
            placeholder="æœç´¢ç¯ä¿çŸ¥è¯†ã€æ´»åŠ¨..."
            @confirm="handleSearch">
          <icon-close-circle 
            v-if="searchKeyword" 
            class="absolute right-10 top-2-5 text-gray-400" 
            @tap="clearSearch">
          </icon-close-circle>
          <icon-search class="absolute right-3 top-2-5 text-gray-400" @tap="handleSearch"></icon-search>
        </view>
        
        <!-- æœç´¢çŠ¶æ€ -->
        <view v-if="isSearchMode" class="search-status mt-2">
          <view class="flex items-center">
            <text class="text-sm">å…³é”®è¯: "{{ searchKeyword }}"</text>
            <text class="text-xs text-gray-500 ml-2">(æ‰¾åˆ° {{ searchResults.length }} æ¡ç»“æœ)</text>
            <view class="ml-auto">
              <text class="text-green-500 text-sm" @tap="exitSearch">é€€å‡ºæœç´¢</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- åˆ†ç±»å¯¼èˆª -->
    <view class="px-4 py-4 bg-white">
      <scroll-view scroll-x class="flex whitespace-nowrap pb-2" show-scrollbar="false">
        <text class="nav-pill active-pill flex-shrink-0">å…¨éƒ¨</text>
        <text class="nav-pill bg-gray-100 flex-shrink-0 space-left">åƒåœ¾åˆ†ç±»</text>
        <text class="nav-pill bg-gray-100 flex-shrink-0 space-left">èŠ‚èƒ½å‡æ’</text>
        <text class="nav-pill bg-gray-100 flex-shrink-0 space-left">èµ„æºå›æ”¶</text>
        <text class="nav-pill bg-gray-100 flex-shrink-0 space-left">ä½ç¢³ç”Ÿæ´»</text>
      </scroll-view>
    </view>

    <!-- å†…å®¹åŒº -->
    <view class="p-4">
      <!-- æœç´¢ç»“æœ -->
      <view v-if="isSearchMode">
        <!-- æœç´¢ç»“æœä¸ºç©º -->
        <view v-if="searchResults.length === 0" class="flex flex-col items-center py-10">
          <icon-search class="text-gray-300 text-5xl mb-4"></icon-search>
          <text class="text-gray-500">æ²¡æœ‰æ‰¾åˆ°ç›¸å…³å†…å®¹</text>
          <text class="text-gray-400 text-sm mt-2">æ¢ä¸ªå…³é”®è¯è¯•è¯•å§</text>
        </view>
        
        <!-- ç¯ä¿çŸ¥è¯†æœç´¢ç»“æœ -->
        <view v-else>
          <!-- çŸ¥è¯†æœç´¢ç»“æœ -->
          <view v-if="searchKnowledgeResults.length > 0" class="mb-6">
            <view class="flex justify-between items-center mb-3">
              <text class="text-lg font-semibold">ç¯ä¿çŸ¥è¯†</text>
              <view class="flex items-center" @tap="navigateToKnowledgeList">
                <text class="text-sm text-gray-500">æŸ¥çœ‹æ›´å¤š</text>
                <icon-right class="text-xs text-gray-500 ml-1" size="12"></icon-right>
              </view>
            </view>
            
            <!-- çŸ¥è¯†å¡ç‰‡åˆ—è¡¨ -->
            <view 
              v-for="item in searchKnowledgeResults" 
              :key="item._id"
              class="card bg-white mb-4" 
              @tap="navigateToKnowledgeDetail(item._id)">
              
              <template v-if="item.image">
                <image :src="item.image" mode="aspectFill" class="knowledge-img"></image>
                <view class="p-3">
                  <view class="flex mb-2">
                    <text class="green-tag" v-if="item.tags"># {{ item.tags.split(',')[0] }}</text>
                  </view>
                  <text class="font-medium mb-2 block">{{ item.title }}</text>
                  <view class="flex items-center text-gray-500 text-xs">
                    <icon-eye class="mr-1" size="14"></icon-eye>
                    <text class="mr-3">{{ item.views || 0 }}</text>
                    <icon-like class="mr-1" size="14"></icon-like>
                    <text>{{ item.likes || 0 }}</text>
                    <text class="ml-auto">{{ formatDate(item.created_at) }}</text>
                  </view>
                </view>
              </template>
              
              <template v-else>
                <view class="flex">
                  <view class="p-3 flex-grow">
                    <view class="flex mb-2">
                      <text class="green-tag" v-if="item.tags"># {{ item.tags.split(',')[0] }}</text>
                    </view>
                    <text class="font-medium mb-2 block">{{ item.title }}</text>
                    <view class="flex items-center text-gray-500 text-xs">
                      <icon-eye class="mr-1" size="14"></icon-eye>
                      <text class="mr-3">{{ item.views || 0 }}</text>
                      <icon-like class="mr-1" size="14"></icon-like>
                      <text>{{ item.likes || 0 }}</text>
                      <text class="ml-auto">{{ formatDate(item.created_at) }}</text>
                    </view>
                  </view>
                </view>
              </template>
            </view>
          </view>
          
          <!-- æ´»åŠ¨æœç´¢ç»“æœ -->
          <view v-if="searchActivityResults.length > 0">
            <view class="flex justify-between items-center mb-3">
              <text class="text-lg font-semibold">å…¬ç›Šæ´»åŠ¨</text>
              <view class="flex items-center" @tap="navigateToAllActivities">
                <text class="text-sm text-gray-500">æŸ¥çœ‹æ›´å¤š</text>
                <icon-right class="text-xs text-gray-500 ml-1" size="12"></icon-right>
              </view>
            </view>
            
            <!-- æ´»åŠ¨å¡ç‰‡åˆ—è¡¨ -->
            <view 
              v-for="(activity, index) in searchActivityResults" 
              :key="activity._id || index"
              class="activity-card bg-white mb-4 rounded-lg"
              @tap="navigateToDetail(activity._id)">
              <view class="p-4">
                <!-- æ´»åŠ¨æ ‡é¢˜å’ŒçŠ¶æ€ -->
                <view class="flex justify-between items-center mb-2">
                  <text class="font-medium text-base">{{ activity.title }}</text>
                  <text 
                    :class="getStatusTextClass(activity)"
                    class="text-xs">
                    {{ activity.status }}
                  </text>
                </view>
                
                <!-- æ´»åŠ¨æè¿° -->
                <text class="text-gray-600 text-sm mb-3">{{ activity.description }}</text>
                
                <!-- æ´»åŠ¨åœ°ç‚¹ -->
                <view class="flex items-center mb-2 text-gray-500 text-sm">
                  <icon-location class="mr-1" size="14"></icon-location>
                  <text>{{ activity.location }}</text>
                </view>
                
                <!-- æ´»åŠ¨æ—¶é—´ -->
                <view class="flex items-center mb-3 text-gray-500 text-sm">
                  <icon-calendar class="mr-1" size="14"></icon-calendar>
                  <text>{{ activity.activity_time }}</text>
                </view>
                
                <!-- å‚ä¸äººæ•°å’ŒæŠ¥åæŒ‰é’® -->
                <view class="flex items-center justify-between">
                  <!-- å‚ä¸äººæ•° -->
                  <view class="flex items-center">
                    <view class="flex mr-2">
                      <view class="activity-avatar-icon">ğŸ§‘</view>
                      <view class="activity-avatar-icon ml-n2">ğŸ‘©</view>
                      <view class="activity-avatar-icon ml-n2">ğŸ‘¨</view>
                    </view>
                    <text class="text-xs text-gray-500">{{ getParticipantsCount(activity) }}äººå·²æŠ¥å</text>
                  </view>
                  
                  <!-- æŠ¥åæŒ‰é’® -->
                  <button 
                    :class="getActionButtonClass(activity)"
                    @tap.stop="handleActivityAction(activity)">
                    {{ activity.status === 'æŠ¥åä¸­' ? 'ç«‹å³æŠ¥å' : 'æŸ¥çœ‹è¯¦æƒ…' }}
                  </button>
                </view>
              </view>
            </view>
          </view>
        </view>
      </view>
      
      <!-- æ­£å¸¸é¦–é¡µå†…å®¹ -->
      <view v-else>
        <!-- æ¨èç¯ä¿çŸ¥è¯† -->
        <view class="mb-6">
          <view class="flex justify-between items-center mb-3">
            <text class="text-lg font-semibold">ç¯ä¿çŸ¥è¯†</text>
            <view class="flex items-center" @tap="navigateToKnowledgeList">
              <text class="text-sm text-gray-500">æŸ¥çœ‹æ›´å¤š</text>
              <icon-right class="text-xs text-gray-500 ml-1" size="12"></icon-right>
            </view>
          </view>

          <!-- é™æ€çŸ¥è¯†å¡ç‰‡ -->
          <!-- ç¬¬ä¸€å¼ å¡ç‰‡ -->
          <view class="card bg-white mb-4" @tap="navigateToKnowledgeDetail('static1')">
            <image src="/static/images/userspost/garbage-sorting.jpeg" mode="aspectFill" class="knowledge-img"></image>
            <view class="p-3">
              <view class="flex mb-2">
                <text class="green-tag"># åƒåœ¾åˆ†ç±»</text>
              </view>
              <text class="font-medium mb-2 block">ä¸€å¼ å›¾çœ‹æ‡‚å®¶åº­åƒåœ¾å¦‚ä½•æ­£ç¡®åˆ†ç±»</text>
              <view class="flex items-center text-gray-500 text-xs">
                <icon-eye class="mr-1" size="14"></icon-eye>
                <text class="mr-3">1234</text>
                <icon-like class="mr-1" size="14"></icon-like>
                <text>56</text>
                <text class="ml-auto">3å°æ—¶å‰</text>
              </view>
            </view>
          </view>

          <!-- ç¬¬äºŒå¼ å¡ç‰‡ -->
          <view class="card bg-white" @tap="navigateToKnowledgeDetail('static2')">
            <view class="flex">
              <view class="p-3 flex-grow">
                <view class="flex mb-2">
                  <text class="green-tag"># èŠ‚èƒ½å‡æ’</text>
                </view>
                <text class="font-medium mb-2 block">æ—¥å¸¸ç”¨ç”µå°çªé—¨ï¼Œè½»æ¾èŠ‚èƒ½30%</text>
                <view class="flex items-center text-gray-500 text-xs">
                  <icon-eye class="mr-1" size="14"></icon-eye>
                  <text class="mr-3">867</text>
                  <icon-like class="mr-1" size="14"></icon-like>
                  <text>42</text>
                  <text class="ml-auto">æ˜¨å¤©</text>
                </view>
              </view>
              <view class="p-3">
                <image src="/static/images/userspost/energy-saving.jpeg" mode="aspectFill" class="small-img"></image>
              </view>
            </view>
          </view>
        </view>

        <!-- å…¬ç›Šæ´»åŠ¨ -->
        <view>
          <view class="flex justify-between items-center mb-3">
            <text class="text-lg font-semibold">å…¬ç›Šæ´»åŠ¨</text>
            <view class="flex items-center" @tap="navigateToAllActivities">
              <text class="text-sm text-gray-500">æŸ¥çœ‹æ›´å¤š</text>
              <icon-right class="text-xs text-gray-500 ml-1" size="12"></icon-right>
            </view>
          </view>

          <!-- åŠ è½½ä¸­ -->
          <view v-if="loading" class="flex justify-center py-4">
            <view class="loading-circle"></view>
          </view>
          
          <!-- é”™è¯¯æç¤º -->
          <view v-else-if="hasError" class="card bg-white p-4">
            <view class="flex flex-col items-center justify-center py-4">
              <text class="text-red-500 mb-2">åŠ è½½å¤±è´¥</text>
              <text class="text-gray-500 text-sm mb-3">{{ errorMessage }}</text>
              <button class="bg-green-50 text-green-600 text-sm px-4 py-2 rounded-full" @tap="getActivityList">
                é‡æ–°åŠ è½½
              </button>
            </view>
          </view>
          
          <!-- æ— æ´»åŠ¨æç¤º -->
          <view v-else-if="activities.length === 0" class="card bg-white p-4">
            <view class="flex flex-col items-center justify-center py-4">
              <text class="text-gray-500">æš‚æ— å…¬ç›Šæ´»åŠ¨ï¼Œæ•¬è¯·æœŸå¾…</text>
            </view>
          </view>

          <!-- æ´»åŠ¨å¡ç‰‡ -->
          <block v-else>
            <view 
              v-for="(activity, index) in activities" 
              :key="activity._id || index"
              class="activity-card bg-white mb-4 rounded-lg"
              @tap="navigateToDetail(activity._id)">
              <view class="p-4">
                <!-- æ´»åŠ¨æ ‡é¢˜å’ŒçŠ¶æ€ -->
                <view class="flex justify-between items-center mb-2">
                  <text class="font-medium text-base">{{ activity.title }}</text>
                  <text 
                    :class="getStatusTextClass(activity)"
                    class="text-xs">
                    {{ getDisplayStatus(activity) }}
                  </text>
                </view>
                
                <!-- æ´»åŠ¨æè¿° -->
                <text class="text-gray-600 text-sm mb-3">{{ activity.description }}</text>
                
                <!-- æ´»åŠ¨åœ°ç‚¹ -->
                <view class="flex items-center mb-2 text-gray-500 text-sm">
                  <icon-location class="mr-1" size="14"></icon-location>
                  <text>{{ activity.location }}</text>
                </view>
                
                <!-- æ´»åŠ¨æ—¶é—´ -->
                <view class="flex items-center mb-3 text-gray-500 text-sm">
                  <icon-calendar class="mr-1" size="14"></icon-calendar>
                  <text>{{ activity.activity_time }}</text>
                </view>
                
                <!-- å‚ä¸äººæ•°å’ŒæŠ¥åæŒ‰é’® -->
                <view class="flex items-center justify-between">
                  <!-- å‚ä¸äººæ•° -->
                  <view class="flex items-center">
                    <view class="flex mr-2">
                      <view class="activity-avatar-icon">ğŸ§‘</view>
                      <view class="activity-avatar-icon ml-n2">ğŸ‘©</view>
                      <view class="activity-avatar-icon ml-n2">ğŸ‘¨</view>
                    </view>
                    <text class="text-xs text-gray-500">{{ getParticipantsCount(activity) }}äººå·²æŠ¥å</text>
                  </view>
                  
                  <!-- æŠ¥åæŒ‰é’® -->
                  <button 
                    :class="getActionButtonClass(activity)"
                    @tap.stop="handleActivityAction(activity)">
                    {{ getActionButtonText(activity) }}
                  </button>
                </view>
              </view>
            </view>
          </block>
        </view>
      </view>
    </view>
  </view>
</template>

<script setup>
import { ref, onMounted, onErrorCaptured, computed } from 'vue';
import { onShow, onPullDownRefresh } from '@dcloudio/uni-app';
import { getTopActivities, enrollActivity } from '../../services/userActivity.js';
import { searchContent } from '../../services/search.js';
import { getKnowledgeList } from '../../services/knowledge.js';

// æ´»åŠ¨åˆ—è¡¨
const activities = ref([]);
const loading = ref(true);
const hasError = ref(false);
const errorMessage = ref('');

// ç¯ä¿çŸ¥è¯†åˆ—è¡¨
const knowledgeList = ref([]);
const knowledgeLoading = ref(false);

// æœç´¢ç›¸å…³
const searchKeyword = ref('');
const searchResults = ref([]);
const isSearchMode = ref(false);
const searchTotal = ref(0);

// æ•è·é”™è¯¯
onErrorCaptured((err, instance, info) => {
  console.error('é¦–é¡µæ•è·åˆ°é”™è¯¯:', err);
  console.log('é”™è¯¯å‘ç”Ÿåœ¨:', info);
  hasError.value = true;
  errorMessage.value = err.message || 'åŠ è½½æ•°æ®æ—¶å‡ºé”™';
  return false; // é˜»æ­¢é”™è¯¯ç»§ç»­ä¼ æ’­
});

// è·å–æ´»åŠ¨åˆ—è¡¨
const getActivityList = async () => {
  loading.value = true;
  hasError.value = false;
  try {
    console.log('å¼€å§‹è·å–é¦–é¡µæ´»åŠ¨åˆ—è¡¨...');
    const result = await getTopActivities();
    console.log('è·å–åˆ°çš„æ´»åŠ¨åˆ—è¡¨:', result);
    
    if (!result || result.length === 0) {
      console.warn('æ²¡æœ‰æ´»åŠ¨æ•°æ®ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€');
      activities.value = [];
    } else {
      activities.value = result;
      console.log('é¦–é¡µæ˜¾ç¤ºçš„æ´»åŠ¨æ•°é‡:', activities.value.length);
      activities.value.forEach((activity, index) => {
        console.log(`æ´»åŠ¨${index+1}: ${activity.title}, çŠ¶æ€: ${activity.status}, å·²æŠ¥å: ${activity.isEnrolled}, å·²æ‰“å¡: ${activity.isCheckedIn}`);
      });
    }
  } catch (error) {
    console.error('è·å–æ´»åŠ¨åˆ—è¡¨å¤±è´¥', error);
    hasError.value = true;
    errorMessage.value = error.message || 'è·å–æ´»åŠ¨æ•°æ®å¤±è´¥';
    activities.value = [];
  } finally {
    loading.value = false;
  }
};

// ä¸‹æ‹‰åˆ·æ–°å¤„ç†å‡½æ•°
onPullDownRefresh(async () => {
  console.log('è§¦å‘ä¸‹æ‹‰åˆ·æ–°...');
  try {
    await getActivityList();
    uni.showToast({
      title: 'åˆ·æ–°æˆåŠŸ',
      icon: 'success',
      duration: 1500
    });
  } catch (error) {
    console.error('åˆ·æ–°å¤±è´¥:', error);
    uni.showToast({
      title: 'åˆ·æ–°å¤±è´¥',
      icon: 'none',
      duration: 1500
    });
  } finally {
    // åœæ­¢ä¸‹æ‹‰åˆ·æ–°åŠ¨ç”»
    uni.stopPullDownRefresh();
  }
});

// è·å–çŠ¶æ€æ–‡æœ¬æ ·å¼ç±»
const getStatusTextClass = (activity) => {
  if (activity.isCheckedIn) {
    return 'status-tag status-completed'; // å·²å®Œæˆæ‰“å¡ï¼Œæ˜¾ç¤ºç°è‰²
  } else if (activity.isEnrolled) {
    return 'status-tag status-ongoing'; // å·²æŠ¥åä½†æœªæ‰“å¡ï¼Œæ˜¾ç¤ºç»¿è‰²
  }
  
  switch (activity.status) {
    case 'æŠ¥åä¸­':
      return 'status-tag status-enrolling'; // æŠ¥åä¸­ï¼Œæ˜¾ç¤ºæ©™è‰²
    case 'æœªå¼€å§‹':
      return 'status-tag status-upcoming'; // æœªå¼€å§‹ï¼Œæ˜¾ç¤ºè“è‰²
    case 'å·²ç»“æŸ':
      return 'status-tag status-ended'; // å·²ç»“æŸï¼Œæ˜¾ç¤ºç°è‰²
    default:
      return 'status-tag status-default';
  }
};

// è·å–ç”¨æˆ·ç«¯æ˜¾ç¤ºçš„çŠ¶æ€æ–‡æœ¬
const getDisplayStatus = (activity) => {
  if (activity.isCheckedIn) {
    return 'å·²å®Œæˆ'; // å·²å®Œæˆæ‰“å¡
  } else if (activity.isEnrolled) {
    return 'è¿›è¡Œä¸­'; // å·²æŠ¥åä½†æœªæ‰“å¡
  }
  
  return activity.status; // å¦åˆ™æ˜¾ç¤ºåŸå§‹çŠ¶æ€
};

// è·å–æ“ä½œæŒ‰é’®æ–‡æœ¬
const getActionButtonText = (activity) => {
  if (activity.isCheckedIn) {
    return 'å·²å®Œæˆ';
  } else if (activity.isEnrolled) {
    return 'æŸ¥çœ‹è¯¦æƒ…';
  } else if (activity.status === 'æœªå¼€å§‹') {
    return 'ç­‰å¾…å¼€å§‹';
  } else if (activity.status === 'å·²ç»“æŸ') {
    return 'å·²ç»“æŸ';
  } else {
    return 'ç«‹å³æŠ¥å';
  }
};

// è·å–æŒ‰é’®æ ·å¼ç±»
const getActionButtonClass = (activity) => {
  if (activity.status === 'æœªå¼€å§‹' || activity.status === 'å·²ç»“æŸ') {
    return 'ml-auto bg-gray-200 text-gray-500 text-sm px-4 py-1 rounded-full';
  } else {
    return 'ml-auto bg-green-50 text-green-600 text-sm px-4 py-1 rounded-full';
  }
};

// å¤„ç†æ´»åŠ¨æ“ä½œ
const handleActivityAction = (activity) => {
  if (activity.isCheckedIn) {
    // å·²å®Œæˆï¼Œä¸åšä»»ä½•æ“ä½œ
    uni.showToast({
      title: 'æ‚¨å·²å®Œæˆè¯¥æ´»åŠ¨',
      icon: 'none'
    });
  } else if (activity.isEnrolled) {
    // å·²æŠ¥åä½†æœªå®Œæˆï¼Œè·³è½¬åˆ°è¯¦æƒ…é¡µ
    uni.navigateTo({
      url: `/pages/home/activity-detail?id=${activity._id}`
    });
  } else if (activity.status === 'æŠ¥åä¸­') {
    // æŠ¥åä¸­ï¼Œè¿›è¡ŒæŠ¥åæ“ä½œ
    handleEnrollActivity(activity._id);
  } else {
    // å…¶ä»–çŠ¶æ€ï¼Œè·³è½¬åˆ°è¯¦æƒ…é¡µ
    uni.navigateTo({
      url: `/pages/home/activity-detail?id=${activity._id}`
    });
  }
};

// å¤„ç†æŠ¥åæ´»åŠ¨
const handleEnrollActivity = async (activityId) => {
  try {
    const result = await enrollActivity(activityId);
    if (result && result.success) {
      uni.showToast({
        title: 'æŠ¥åæˆåŠŸ',
        icon: 'success'
      });
      
      // æ›´æ–°æœ¬åœ°æ´»åŠ¨åˆ—è¡¨
      const index = activities.value.findIndex(item => item._id === activityId);
      if (index > -1) {
        activities.value[index].isEnrolled = true;
      }
    } else {
      uni.showToast({
        title: result.message || 'æŠ¥åå¤±è´¥',
        icon: 'none'
      });
    }
  } catch (error) {
    console.error('æŠ¥åæ´»åŠ¨å¤±è´¥', error);
    uni.showToast({
      title: 'æŠ¥åå¤±è´¥ï¼Œè¯·ç¨åå†è¯•',
      icon: 'none'
    });
  }
};

// è·å–å‚ä¸äººæ•°
const getParticipantsCount = (activity) => {
  return activity.enrollCount || 0;
};

// è·³è½¬åˆ°æ´»åŠ¨è¯¦æƒ…
const navigateToDetail = (activityId) => {
  uni.navigateTo({
    url: `/pages/home/activity-detail?id=${activityId}`
  });
};

// è·³è½¬åˆ°å…¨éƒ¨æ´»åŠ¨
const navigateToAllActivities = () => {
  uni.navigateTo({
    url: '/pages/home/activity-list'
  });
};

// è·³è½¬åˆ°çŸ¥è¯†è¯¦æƒ…é¡µ
const navigateToKnowledgeDetail = (knowledgeId) => {
  if (knowledgeId === 'static1') {
    uni.navigateTo({
      url: '/pages/home/knowledge-static?id=1'
    });
  } else if (knowledgeId === 'static2') {
    uni.navigateTo({
      url: '/pages/home/knowledge-static?id=2'
    });
  } else {
    uni.navigateTo({
      url: `/pages/home/knowledge-detail?id=${knowledgeId}`
    });
  }
};

// è·³è½¬åˆ°çŸ¥è¯†åˆ—è¡¨é¡µ
const navigateToKnowledgeList = () => {
  uni.navigateTo({
    url: '/pages/home/knowledge-list'
  });
};

// æ‰§è¡Œæœç´¢
const handleSearch = () => {
  if (!searchKeyword.value.trim()) {
    uni.showToast({
      title: 'è¯·è¾“å…¥æœç´¢å…³é”®è¯',
      icon: 'none'
    });
    return;
  }
  
  performSearch(searchKeyword.value);
};

// æ¸…é™¤æœç´¢å†…å®¹
const clearSearch = () => {
  searchKeyword.value = '';
  if (isSearchMode.value) {
    exitSearch();
  }
};

// é€€å‡ºæœç´¢æ¨¡å¼
const exitSearch = () => {
  isSearchMode.value = false;
  searchResults.value = [];
  searchKeyword.value = '';
};

// æœç´¢å¤„ç†
const performSearch = async (keyword) => {
  try {
    isSearchMode.value = true;
    const results = await searchContent(keyword);
    searchResults.value = results;
    searchTotal.value = results.length;
  } catch (error) {
    console.error('æœç´¢å¤±è´¥', error);
    uni.showToast({
      title: 'æœç´¢å¤±è´¥ï¼Œè¯·ç¨åå†è¯•',
      icon: 'none'
    });
    searchResults.value = [];
  }
};

// åˆå§‹åŒ–åŠ è½½æ´»åŠ¨åˆ—è¡¨
onMounted(() => {
  getActivityList();
});

// æ¯æ¬¡æ˜¾ç¤ºé¡µé¢æ—¶åˆ·æ–°æ´»åŠ¨
onShow(() => {
  console.log('é¦–é¡µæ˜¾ç¤ºï¼Œåˆ·æ–°æ´»åŠ¨æ•°æ®...');
  setTimeout(() => {
    getActivityList();
  }, 500); // å»¶è¿ŸåŠ è½½ï¼Œé¿å…åˆå§‹åŒ–é—®é¢˜
});

// è®¡ç®—å±æ€§ï¼šè¿‡æ»¤çŸ¥è¯†æœç´¢ç»“æœ
const searchKnowledgeResults = computed(() => {
  return searchResults.value.filter(item => item.type === 'knowledge');
});

// è®¡ç®—å±æ€§ï¼šè¿‡æ»¤æ´»åŠ¨æœç´¢ç»“æœ
const searchActivityResults = computed(() => {
  return searchResults.value.filter(item => item.type === 'activity');
});

// æ·»åŠ æ—¥æœŸæ ¼å¼åŒ–å‡½æ•°
// æ ¼å¼åŒ–æ—¥æœŸ
const formatDate = (timestamp) => {
  if (!timestamp) return '';
  
  const date = new Date(timestamp);
  const now = new Date();
  const diff = now - date;
  
  // ä¸€å°æ—¶å†…
  if (diff < 60 * 60 * 1000) {
    const minutes = Math.floor(diff / (60 * 1000));
    return `${minutes}åˆ†é’Ÿå‰`;
  }
  
  // 24å°æ—¶å†…
  if (diff < 24 * 60 * 60 * 1000) {
    const hours = Math.floor(diff / (60 * 60 * 1000));
    return `${hours}å°æ—¶å‰`;
  }
  
  // æ˜¨å¤©
  const yesterday = new Date(now);
  yesterday.setDate(yesterday.getDate() - 1);
  if (date.getDate() === yesterday.getDate()) {
    return 'æ˜¨å¤©';
  }
  
  // ä»Šå¹´å†…
  if (date.getFullYear() === now.getFullYear()) {
    return `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
  }
  
  // å…¶ä»–
  return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
};
</script>

<style>
.container {
  background-color: #f8f9fa;
  font-family: "PingFang SC", "Helvetica Neue", Arial, sans-serif;
  color: #333;
  padding-bottom: 80px;
}

.search-bar {
  border-radius: 20px;
}

.nav-pill {
  border-radius: 16px;
  padding: 6px 12px;
  font-size: 14px;
  display: inline-block;
}

.active-pill {
  background-color: #4CAF50;
  color: white;
}

.card {
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.green-tag {
  background-color: rgba(76, 175, 80, 0.1);
  color: #4CAF50;
  border-radius: 12px;
  padding: 2px 10px;
  font-size: 12px;
  display: inline-block;
}

.avatar-group {
  display: flex;
  margin-right: -10px;
}

.avatar-sm {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  border: 1px solid white;
  margin-right: -10px;
  object-fit: cover;
}

/* ä¿®å¤é—´è·ç±» */
.space-left {
  margin-left: 12px;
}

.tag-space {
  margin-left: 8px;
}

/* å›¾ç‰‡æ ·å¼ä¼˜åŒ– */
.knowledge-img {
  height: 140px;
  width: 100%;
  object-fit: cover;
  object-position: center;
}

.small-img {
  width: 96px;
  height: 96px;
  object-fit: cover;
  object-position: center;
  border-radius: 8px;
}

/* å·¥å…·ç±» */
.px-4 { padding-left: 16px; padding-right: 16px; }
.pt-10 { padding-top: 40px; }
.pb-4 { padding-bottom: 16px; }
.py-4 { padding-top: 16px; padding-bottom: 16px; }
.p-4 { padding: 16px; }
.p-3 { padding: 12px; }
.mb-4 { margin-bottom: 16px; }
.mb-3 { margin-bottom: 12px; }
.mb-2 { margin-bottom: 8px; }
.mb-1 { margin-bottom: 4px; }
.mr-4 { margin-right: 16px; }
.mr-3 { margin-right: 12px; }
.mr-2 { margin-right: 8px; }
.mr-1 { margin-right: 4px; }
.ml-auto { margin-left: auto; }
.ml-2 { margin-left: 8px; }
.ml-1 { margin-left: 4px; }
.mt-3 { margin-top: 12px; }
.mt-1 { margin-top: 4px; }
.mx-2 { margin-left: 8px; margin-right: 8px; }
.my-auto { margin-top: auto; margin-bottom: auto; }

.bg-white { background-color: #ffffff; }
.bg-gray-100 { background-color: #f3f4f6; }
.bg-green-50 { background-color: #f0fdf4; }

.text-xl { font-size: 20px; }
.text-lg { font-size: 18px; }
.text-sm { font-size: 14px; }
.text-xs { font-size: 12px; }
.font-bold { font-weight: 700; }
.font-semibold { font-weight: 600; }
.font-medium { font-weight: 500; }

.text-gray-400 { color: #9ca3af; }
.text-gray-500 { color: #6b7280; }
.text-green-500 { color: #4CAF50; }
.text-green-600 { color: #4CAF50; }
.text-yellow-500 { color: #F59E0B; }

.flex { display: flex; }
.flex-grow { flex-grow: 1; }
.flex-shrink-0 { flex-shrink: 0; }
.items-center { align-items: center; }
.justify-between { justify-content: space-between; }

.w-full { width: 100%; }
.h-32 { height: 128px; }
.w-24 { width: 96px; }
.h-24 { height: 96px; }

.rounded-md { border-radius: 6px; }
.rounded-full { border-radius: 9999px; }

.object-cover { object-fit: cover; }

.shadow-sm { box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }

.pb-2 { padding-bottom: 8px; }

.whitespace-nowrap { white-space: nowrap; }

.relative { position: relative; }
.absolute { position: absolute; }
.right-3 { right: 12px; }
.top-2-5 { top: 10px; }

.activity-card {
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.activity-avatar-icon {
  width: 24px;
  height: 24px;
  background-color: #f3f4f6;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  border: 1px solid white;
}

.ml-n2 {
  margin-left: -8px;
}

/* æœç´¢å®¹å™¨æ ·å¼ */
.search-container {
  margin-bottom: 5px;
}

.search-status {
  background-color: #f8f9fa;
  padding: 5px 8px;
  border-radius: 8px;
}

.mt-2 {
  margin-top: 8px;
}

/* çŠ¶æ€æ ‡ç­¾æ ·å¼ */
.status-tag {
  font-size: 12px;
  font-weight: 600;
  border-radius: 9999px;
  padding: 2px 8px;
}

.status-enrolling {
  color: #F59E0B;
  background-color: rgba(245, 158, 11, 0.1);
}

.status-ongoing {
  color: #4CAF50;
  background-color: rgba(76, 175, 80, 0.1);
}

.status-upcoming {
  color: #3b82f6;
  background-color: rgba(59, 130, 246, 0.1);
}

.status-ended, .status-completed {
  color: #6b7280;
  background-color: rgba(107, 114, 128, 0.1);
}

.status-default {
  color: #6b7280;
  background-color: rgba(107, 114, 128, 0.1);
}

/* åŠ è½½åœˆæ ·å¼ */
.loading-circle {
  width: 30px;
  height: 30px;
  border: 3px solid rgba(76, 175, 80, 0.2);
  border-top: 3px solid #4CAF50;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style> 