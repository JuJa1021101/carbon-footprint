{"version":3,"file":"orders.js","sources":["pages/profile/orders.vue","../../../Software/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvcHJvZmlsZS9vcmRlcnMudnVl"],"sourcesContent":["<template>\n  <view class=\"container\">\n    <!-- 头部导航 -->\n    <view class=\"header bg-white\">\n      <view class=\"header-content\">\n        <view class=\"back-button\" @tap=\"goBack\">\n          <text class=\"iconfont icon-right\" style=\"transform: rotate(180deg);\"></text>\n        </view>\n        <text class=\"title\">订单管理</text>\n        <view class=\"placeholder\"></view>\n      </view>\n    </view>\n\n    <!-- 订单列表 -->\n    <view class=\"order-list\" v-if=\"!loading && orders.length > 0\">\n      <view class=\"card bg-white mb-3\" v-for=\"(order, index) in orders\" :key=\"index\">\n        <!-- 订单头部信息 -->\n        <view class=\"card-header px-4 py-3 flex items-center justify-between\">\n          <view class=\"flex items-center\">\n            <text class=\"iconfont icon-shopping-bag text-green-500 mr-2\"></text>\n            <text class=\"text-sm\">订单号: {{formatOrderId(order._id)}}</text>\n          </view>\n          <view :style=\"{color: getStatusColor(order.status)}\">\n            {{getStatusText(order.status)}}\n          </view>\n        </view>\n\n        <!-- 订单商品信息 -->\n        <view class=\"card-body px-4 py-3 border-t border-b border-gray-100\">\n          <!-- 商品信息 -->\n          <view class=\"flex items-center\">\n            <image \n              class=\"reward-image\" \n              :src=\"order.reward?.image || order.reward_image || '/static/images/mall/canvas-bag.png'\" \n              mode=\"aspectFill\"\n            ></image>\n            <view class=\"ml-3 flex-grow\">\n              <view class=\"text-lg font-medium truncate\">{{order.reward?.name || order.reward_name || '未知商品'}}</view>\n              <view class=\"text-sm text-gray-500 mt-1\">兑换时间: {{formatTime(order.created_at || order.redemption_time)}}</view>\n              <view class=\"text-sm text-green-500 font-medium mt-1\">消耗积分: {{order.points_used}}</view>\n            </view>\n          </view>\n        </view>\n\n        <!-- 订单底部信息 -->\n        <view class=\"card-footer px-4 py-3\">\n          <view class=\"flex justify-between items-center\">\n            <view>\n              <text class=\"text-sm text-gray-500\" v-if=\"order.address || order.address_info\">\n                收货地址: {{formatAddress(order.address || order.address_info)}}\n              </text>\n              <text class=\"text-sm text-gray-500\" v-else>无收货地址信息</text>\n            </view>\n\n            <!-- 订单操作按钮 -->\n            <view class=\"flex\">\n              <button \n                class=\"mini-btn\" \n                v-if=\"['pending', 'processing'].includes(order.status)\"\n                @tap=\"trackOrder(order)\"\n              >\n                查询物流\n              </button>\n              <button \n                class=\"mini-btn ml-2\" \n                v-if=\"['delivered'].includes(order.status)\"\n                @tap=\"confirmReceipt(order)\"\n              >\n                确认收货\n              </button>\n            </view>\n          </view>\n        </view>\n      </view>\n    </view>\n\n    <!-- 加载中状态 -->\n    <view class=\"loading-container\" v-if=\"loading\">\n      <view class=\"loading-spinner\"></view>\n      <text class=\"loading-text\">加载中...</text>\n    </view>\n\n    <!-- 空状态 -->\n    <view class=\"empty-state\" v-if=\"!loading && orders.length === 0\">\n      <image src=\"/static/images/empty-order.png\" class=\"empty-icon\" mode=\"aspectFit\"></image>\n      <text class=\"empty-text\">您还没有订单记录</text>\n      <button class=\"go-shop-btn\" @tap=\"navigateToMall\">去积分商城看看</button>\n    </view>\n\n    <!-- 下拉刷新指示器 -->\n    <uni-transition mode-class=\"fade\" :duration=\"300\" :show=\"isRefreshing && !loading\">\n      <view class=\"refresh-tip\">\n        <text class=\"iconfont icon-refresh mr-1 refreshing\" v-if=\"isRefreshing\"></text>\n        <text>正在刷新...</text>\n      </view>\n    </uni-transition>\n    \n    <!-- 初始化测试数据按钮 (开发模式) -->\n    <button class=\"test-data-btn\" @tap=\"initTestData\" v-if=\"isDev\">初始化测试数据</button>\n  </view>\n</template>\n\n<script setup>\nimport { ref, onMounted, onBeforeUnmount } from 'vue';\nimport { getUserOrders, getOrderStatusText, getOrderStatusColor, formatOrderTime } from '../../services/orders.js';\n\n// 订单列表数据\nconst orders = ref([]);\nconst loading = ref(true);\nconst isRefreshing = ref(false);\nlet pullDownRefreshTimeout = null;\nconst isDev = process.env.NODE_ENV === 'development' || true; // 开发模式标志\n\n// 获取订单数据\nconst loadOrders = async (refresh = false) => {\n  try {\n    if (!refresh) loading.value = true;\n    const result = await getUserOrders(refresh);\n    \n    if (result && result.success) {\n      console.log('获取到订单数据:', result.data.length);\n      orders.value = result.data || [];\n    } else {\n      console.error('获取订单数据失败:', result?.message);\n      uni.showToast({\n        title: '获取订单失败',\n        icon: 'none'\n      });\n      orders.value = [];\n    }\n  } catch (error) {\n    console.error('加载订单出错:', error);\n    uni.showToast({\n      title: '加载订单出错',\n      icon: 'none'\n    });\n    orders.value = [];\n  } finally {\n    loading.value = false;\n    if (isRefreshing.value) {\n      // 延迟关闭刷新状态，给用户一个视觉反馈\n      pullDownRefreshTimeout = setTimeout(() => {\n        isRefreshing.value = false;\n        uni.stopPullDownRefresh();\n      }, 600);\n    }\n  }\n};\n\n// 初始化测试数据\nconst initTestData = async () => {\n  try {\n    uni.showLoading({\n      title: '初始化中...'\n    });\n    \n    const { result } = await uniCloud.callFunction({\n      name: 'initOrderData'\n    });\n    \n    if (result && result.success) {\n      uni.showToast({\n        title: `成功创建${result.count}条订单`,\n        icon: 'success'\n      });\n      // 重新加载订单数据\n      setTimeout(() => {\n        loadOrders(true);\n      }, 1000);\n    } else {\n      uni.showToast({\n        title: result?.message || '初始化失败',\n        icon: 'none'\n      });\n    }\n  } catch (error) {\n    console.error('初始化测试数据失败:', error);\n    uni.showToast({\n      title: '初始化失败',\n      icon: 'none'\n    });\n  } finally {\n    uni.hideLoading();\n  }\n};\n\n// 格式化订单ID，只显示后8位\nconst formatOrderId = (id) => {\n  if (!id) return '未知';\n  if (id.length > 8) {\n    return id.substring(id.length - 8);\n  }\n  return id;\n};\n\n// 获取订单状态文本\nconst getStatusText = (status) => {\n  return getOrderStatusText(status);\n};\n\n// 获取订单状态颜色\nconst getStatusColor = (status) => {\n  return getOrderStatusColor(status);\n};\n\n// 格式化时间显示\nconst formatTime = (timestamp) => {\n  return formatOrderTime(timestamp);\n};\n\n// 格式化地址信息\nconst formatAddress = (addressInfo) => {\n  if (!addressInfo) return '无地址信息';\n  \n  const name = addressInfo.name || '';\n  const phone = addressInfo.phone ? addressInfo.phone.substring(0, 3) + '****' + addressInfo.phone.substring(7) : '';\n  const region = addressInfo.region || '';\n  const address = addressInfo.address || '';\n  \n  return `${name} ${phone} ${region} ${address}`.trim();\n};\n\n// 返回上一页\nconst goBack = () => {\n  uni.navigateBack({\n    delta: 1,\n    fail: () => {\n      uni.switchTab({\n        url: '/pages/profile/profile'\n      });\n    }\n  });\n};\n\n// 查询物流\nconst trackOrder = (order) => {\n  uni.showToast({\n    title: '物流查询功能开发中',\n    icon: 'none'\n  });\n};\n\n// 确认收货\nconst confirmReceipt = (order) => {\n  uni.showModal({\n    title: '确认收货',\n    content: '确认已收到商品吗？',\n    success: (res) => {\n      if (res.confirm) {\n        uni.showToast({\n          title: '确认收货成功',\n          icon: 'success'\n        });\n      }\n    }\n  });\n};\n\n// 跳转到积分商城\nconst navigateToMall = () => {\n  uni.switchTab({\n    url: '/pages/mall/mall'\n  });\n};\n\n// 下拉刷新处理\nconst handlePullDownRefresh = () => {\n  console.log('触发下拉刷新');\n  isRefreshing.value = true;\n  loadOrders(true);\n};\n\nonMounted(() => {\n  loadOrders();\n});\n\nonBeforeUnmount(() => {\n  // 清除定时器\n  if (pullDownRefreshTimeout) {\n    clearTimeout(pullDownRefreshTimeout);\n  }\n});\n\n// 定义页面配置\ndefineExpose({\n  onPullDownRefresh() {\n    handlePullDownRefresh();\n  }\n});\n</script>\n\n<style>\n.container {\n  background-color: #f8f9fa;\n  font-family: \"PingFang SC\", \"Helvetica Neue\", Arial, sans-serif;\n  color: #333;\n  padding-bottom: 30px;\n  min-height: 100vh;\n  box-sizing: border-box;\n}\n\n.header {\n  padding: 12px 0;\n  position: sticky;\n  top: 0;\n  z-index: 1000;\n  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);\n}\n\n.header-content {\n  display: flex;\n  align-items: center;\n  justify-content: space-between;\n  padding: 0 15px;\n  width: 100%;\n}\n\n.title {\n  font-size: 18px;\n  font-weight: bold;\n  flex: 1;\n  text-align: center;\n}\n\n.back-button {\n  width: 32px;\n  height: 32px;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  font-size: 20px;\n  color: #333;\n  background-color: #f0f0f0;\n  border-radius: 50%;\n}\n\n.placeholder {\n  width: 32px;\n}\n\n.w-100 {\n  width: 100%;\n}\n\n.w-40 {\n  width: 40px;\n}\n\n.card {\n  border-radius: 12px;\n  overflow: hidden;\n  margin: 0 12px;\n  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);\n}\n\n.order-list {\n  margin-top: 12px;\n}\n\n.reward-image {\n  width: 80px;\n  height: 80px;\n  border-radius: 8px;\n  background-color: #f0f0f0;\n  flex-shrink: 0;\n}\n\n.mini-btn {\n  font-size: 12px;\n  line-height: 2;\n  padding: 0 12px;\n  border-radius: 15px;\n  background-color: #ffffff;\n  border: 1px solid #4CAF50;\n  color: #4CAF50;\n  display: inline-block;\n  min-width: auto;\n}\n\n.loading-container {\n  display: flex;\n  flex-direction: column;\n  align-items: center;\n  justify-content: center;\n  padding: 40px 0;\n}\n\n.loading-spinner {\n  width: 24px;\n  height: 24px;\n  border: 2px solid #4CAF50;\n  border-top-color: transparent;\n  border-radius: 50%;\n  animation: spin 0.8s linear infinite;\n  margin-bottom: 12px;\n}\n\n@keyframes spin {\n  to {\n    transform: rotate(360deg);\n  }\n}\n\n.loading-text {\n  font-size: 14px;\n  color: #6b7280;\n}\n\n.empty-state {\n  display: flex;\n  flex-direction: column;\n  align-items: center;\n  justify-content: center;\n  padding: 60px 30px;\n}\n\n.empty-icon {\n  width: 120px;\n  height: 120px;\n  margin-bottom: 20px;\n  opacity: 0.7;\n}\n\n.empty-text {\n  font-size: 16px;\n  color: #6b7280;\n  margin-bottom: 20px;\n}\n\n.go-shop-btn {\n  background-color: #4CAF50;\n  color: white;\n  font-size: 14px;\n  padding: 6px 20px;\n  border-radius: 20px;\n  border: none;\n}\n\n.refresh-tip {\n  position: fixed;\n  top: 70px;\n  left: 50%;\n  transform: translateX(-50%);\n  background-color: rgba(255, 255, 255, 0.9);\n  border-radius: 20px;\n  padding: 6px 16px;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  font-size: 14px;\n  color: #6b7280;\n  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);\n}\n\n.refreshing {\n  animation: rotating 1.2s linear infinite;\n}\n\n.test-data-btn {\n  position: fixed;\n  bottom: 20px;\n  right: 20px;\n  background-color: #4CAF50;\n  color: white;\n  font-size: 12px;\n  padding: 6px 12px;\n  border-radius: 20px;\n  border: none;\n  opacity: 0.8;\n  z-index: 100;\n}\n\n@keyframes rotating {\n  from {\n    transform: rotate(0deg);\n  }\n  to {\n    transform: rotate(360deg);\n  }\n}\n\n/* 工具类 */\n.px-4 { padding-left: 16px; padding-right: 16px; }\n.py-3 { padding-top: 12px; padding-bottom: 12px; }\n.mb-3 { margin-bottom: 12px; }\n.mr-2 { margin-right: 8px; }\n.mr-1 { margin-right: 4px; }\n.ml-3 { margin-left: 12px; }\n.ml-2 { margin-left: 8px; }\n.mt-1 { margin-top: 4px; }\n.ml-auto { margin-left: auto; }\n\n.bg-white { background-color: #ffffff; }\n.bg-gray-50 { background-color: #f9fafb; }\n.text-green-500 { color: #4CAF50; }\n.text-gray-500 { color: #6b7280; }\n.text-lg { font-size: 18px; }\n.text-sm { font-size: 14px; }\n.font-medium { font-weight: 500; }\n.truncate { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }\n\n.flex { display: flex; }\n.flex-grow { flex-grow: 1; }\n.items-center { align-items: center; }\n.justify-between { justify-content: space-between; }\n\n.border-t { border-top-width: 1px; }\n.border-b { border-bottom-width: 1px; }\n.border-gray-100 { border-color: #f3f4f6; }\n</style> ","import MiniProgramPage from 'D:/Documents/HBuilderProjects/CarbonFootprint/pages/profile/orders.vue'\nwx.createPage(MiniProgramPage)"],"names":["ref","getUserOrders","uni","uniCloud","getOrderStatusText","getOrderStatusColor","formatOrderTime","onMounted","onBeforeUnmount","MiniProgramPage"],"mappings":"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"}