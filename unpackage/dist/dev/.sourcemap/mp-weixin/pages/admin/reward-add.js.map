{"version":3,"file":"reward-add.js","sources":["pages/admin/reward-add.vue","../../../Software/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvYWRtaW4vcmV3YXJkLWFkZC52dWU"],"sourcesContent":["<template>\n  <view class=\"container\">\n    <!-- 顶部导航栏 -->\n    <view class=\"header bg-white px-4 pt-10 pb-3\">\n      <view class=\"flex items-center\">\n        <view @tap=\"goBack\" class=\"p-2\">\n          <IconImage name=\"back\" :size=\"18\" />\n        </view>\n        <view class=\"flex-1 text-center\">\n          <text class=\"text-gray-900 text-lg font-medium\">添加商品</text>\n        </view>\n        <view>\n          <button \n            class=\"publish-btn text-white text-sm bg-green-500 rounded-full px-4 py-1\"\n            :disabled=\"!canSave\"\n            :class=\"{'bg-gray-300': !canSave}\"\n            @tap=\"submitReward\">\n            添加\n          </button>\n        </view>\n      </view>\n    </view>\n\n    <!-- 内容区 - 使用普通view替代scroll-view -->\n    <view class=\"form-wrapper p-4\">\n      <form @submit.prevent>\n        <!-- 商品名称 -->\n        <view class=\"form-item\">\n          <view class=\"form-label mb-1\">商品名称</view>\n          <input \n            v-model=\"name\"\n            class=\"form-input\"\n            placeholder=\"请输入商品名称\"\n            maxlength=\"100\"\n          />\n        </view>\n        \n        <!-- 商品描述 -->\n        <view class=\"form-item\">\n          <view class=\"form-label mb-1\">商品描述</view>\n          <textarea \n            v-model=\"description\" \n            class=\"form-textarea\" \n            placeholder=\"请输入商品描述...\" \n            maxlength=\"500\"\n            auto-height>\n          </textarea>\n        </view>\n        \n        <!-- 商品图片上传 -->\n        <view class=\"form-item\">\n          <view class=\"image-upload-container\">\n            <view class=\"image-upload-label\">商品图片</view>\n            <view class=\"image-upload-area\" @tap=\"chooseImage\">\n              <image v-if=\"imageUrl\" :src=\"imageUrl\" mode=\"aspectFill\" class=\"preview-image\"></image>\n              <view v-else class=\"upload-placeholder\">\n                <IconImage name=\"plus\" :size=\"28\" class=\"mb-2\" />\n                <text class=\"upload-text\">点击上传图片</text>\n              </view>\n            </view>\n          </view>\n        </view>\n        \n        <!-- 积分输入框 -->\n        <view class=\"form-item\">\n          <view class=\"form-label mb-1\">兑换积分</view>\n          <view class=\"form-input-wrapper flex items-center\">\n            <IconImage name=\"bookmark\" :size=\"16\" class=\"mr-2 text-gray-500\" />\n            <input \n              v-model=\"points\"\n              class=\"form-input flex-1 pl-0\"\n              placeholder=\"请输入兑换所需积分\"\n              type=\"number\"\n            />\n          </view>\n        </view>\n        \n        <!-- 库存输入框 -->\n        <view class=\"form-item\">\n          <view class=\"form-label mb-1\">商品库存</view>\n          <view class=\"form-input-wrapper flex items-center\">\n            <IconImage name=\"bookmark\" :size=\"16\" class=\"mr-2 text-gray-500\" />\n            <input \n              v-model=\"stock\"\n              class=\"form-input flex-1 pl-0\"\n              placeholder=\"请输入商品库存\"\n              type=\"number\"\n            />\n          </view>\n        </view>\n        \n        <!-- 商品分类 -->\n        <view class=\"form-item\">\n          <view class=\"form-label mb-1\">商品分类</view>\n          <picker \n            @change=\"onCategoryChange\" \n            :value=\"categoryIndex\" \n            :range=\"categoryOptions\">\n            <view class=\"picker-content\">\n              <text class=\"picker-text\">{{ getCategoryText(categoryOptions[categoryIndex]) }}</text>\n              <IconImage name=\"right\" :size=\"16\" />\n            </view>\n          </picker>\n        </view>\n        \n        <!-- 是否热门 -->\n        <view class=\"form-item\">\n          <view class=\"form-label mb-1\">热门商品</view>\n          <picker \n            @change=\"onHotChange\" \n            :value=\"hotIndex\" \n            :range=\"booleanOptions\">\n            <view class=\"picker-content\">\n              <text class=\"picker-text\">{{ booleanOptions[hotIndex] }}</text>\n              <IconImage name=\"right\" :size=\"16\" />\n            </view>\n          </picker>\n        </view>\n        \n        <!-- 是否限时 -->\n        <view class=\"form-item\">\n          <view class=\"form-label mb-1\">限时商品</view>\n          <picker \n            @change=\"onLimitedChange\" \n            :value=\"limitedIndex\" \n            :range=\"booleanOptions\">\n            <view class=\"picker-content\">\n              <text class=\"picker-text\">{{ booleanOptions[limitedIndex] }}</text>\n              <IconImage name=\"right\" :size=\"16\" />\n            </view>\n          </picker>\n        </view>\n      </form>\n    </view>\n  </view>\n</template>\n\n<script setup>\nimport { ref, computed } from 'vue';\nimport { addReward, uploadImageToStatic } from '../../services/mall.js';\nimport { onLoad, onShow } from '@dcloudio/uni-app';\nimport IconImage from '../../components/IconImage.vue';\n\n// 表单数据\nconst name = ref('');\nconst description = ref('');\nconst imageUrl = ref('');\nconst points = ref('0');\nconst stock = ref('0');\nconst categoryIndex = ref(0);\nconst categoryOptions = ['daily', 'plant', 'coupon'];\nconst hotIndex = ref(0); // 0-否，1-是\nconst limitedIndex = ref(0); // 0-否，1-是\nconst booleanOptions = ['否', '是'];\n\n// 获取分类显示文字\nconst getCategoryText = (category) => {\n  const categories = {\n    'daily': '日常用品',\n    'plant': '绿植花卉',\n    'coupon': '优惠券'\n  };\n  return categories[category] || category;\n};\n\n// 检查管理员登录状态\nconst checkAdminLoginStatus = () => {\n  const adminLoginStatus = uni.getStorageSync('admin_login_status');\n  if (adminLoginStatus !== 'loggedin') {\n    uni.showToast({\n      title: '请先登录管理员账号',\n      icon: 'none',\n      duration: 2000\n    });\n    \n    setTimeout(() => {\n      uni.navigateTo({\n        url: '/pages/admin/login'\n      });\n    }, 1500);\n    return false;\n  }\n  return true;\n};\n\n// 页面加载时检查登录状态\nonLoad(() => {\n  checkAdminLoginStatus();\n});\n\n// 页面显示时检查登录状态\nonShow(() => {\n  checkAdminLoginStatus();\n});\n\n// 跟踪输入框焦点状态\nconst isPointsFocused = ref(false);\nconst isStockFocused = ref(false);\n\n// 验证并格式化数字输入\nconst validateNumberInput = (field) => {\n  if (field === 'points') {\n    // 确保是纯数字，去除非数字字符\n    points.value = points.value.replace(/\\D/g, '');\n    // 如果为空，设置为0\n    if (points.value === '') points.value = '0';\n  } else if (field === 'stock') {\n    // 确保是纯数字，去除非数字字符\n    stock.value = stock.value.replace(/\\D/g, '');\n    // 如果为空，设置为0\n    if (stock.value === '') stock.value = '0';\n  }\n};\n\n// 是否可以保存\nconst canSave = computed(() => {\n  // 添加安全检查，确保值存在再调用trim()\n  const nameValid = name.value && typeof name.value === 'string' && name.value.trim().length > 0;\n  const imageValid = imageUrl.value && typeof imageUrl.value === 'string' && imageUrl.value.trim().length > 0;\n  return nameValid && imageValid;\n});\n\n// 分类选择变化\nconst onCategoryChange = (e) => {\n  categoryIndex.value = e.detail.value;\n};\n\n// 热门选择变化\nconst onHotChange = (e) => {\n  hotIndex.value = e.detail.value;\n};\n\n// 限时选择变化\nconst onLimitedChange = (e) => {\n  limitedIndex.value = e.detail.value;\n};\n\n// 选择图片\nconst chooseImage = () => {\n  uni.chooseImage({\n    count: 1,\n    sizeType: ['compressed'],\n    sourceType: ['album', 'camera'],\n    success: (res) => {\n      // 直接设置临时文件路径\n      imageUrl.value = res.tempFilePaths[0];\n    }\n  });\n};\n\n// 返回上一页\nconst goBack = () => {\n  uni.showModal({\n    title: '提示',\n    content: '是否放弃添加？',\n    success: (res) => {\n      if (res.confirm) {\n        uni.navigateBack();\n      }\n    }\n  });\n};\n\n// 添加商品\nconst submitReward = async () => {\n  // 验证内容\n  if (!canSave.value) {\n    uni.showToast({\n      title: '请完善必填信息',\n      icon: 'none'\n    });\n    return;\n  }\n  \n  // 检查管理员登录状态\n  if (!checkAdminLoginStatus()) {\n    return;\n  }\n  \n  try {\n    // 显示加载状态\n    uni.showLoading({\n      title: '添加中...',\n      mask: true\n    });\n    \n    // 构建商品数据对象\n    const rewardData = {\n      name: name.value,\n      description: description.value,\n      image_url: imageUrl.value, // 传递图片临时路径\n      points: parseInt(points.value) || 0,\n      stock: parseInt(stock.value) || 0,\n      category: categoryOptions[categoryIndex.value],\n      is_hot: hotIndex.value === 1,\n      is_limited: limitedIndex.value === 1\n    };\n    \n    // 调用商品添加服务\n    const result = await addReward(rewardData);\n    \n    uni.hideLoading();\n    uni.showToast({\n      title: '添加成功',\n      icon: 'success'\n    });\n    \n    // 更新商品数量缓存\n    const currentCount = parseInt(uni.getStorageSync('reward_count') || '0');\n    uni.setStorageSync('reward_count', currentCount + 1);\n    \n    // 保存操作消息，供列表页面显示\n    uni.setStorageSync('reward_action_message', `商品\"${name.value}\"添加成功`);\n    \n    // 修改返回逻辑，确保返回到正确页面\n    setTimeout(() => {\n      try {\n        // 使用重定向而不是navigateBack，避免页面栈问题\n        uni.redirectTo({\n          url: '/pages/admin/reward-list',\n          fail: (err) => {\n            console.error('跳转失败:', err);\n            // 如果重定向失败，尝试使用其他方式跳转\n            uni.reLaunch({\n              url: '/pages/admin/reward-list'\n            });\n          }\n        });\n      } catch (navError) {\n        console.error('导航错误:', navError);\n        // 确保在任何情况下都能返回管理员列表页\n        uni.reLaunch({\n          url: '/pages/admin/dashboard'\n        });\n      }\n    }, 1500);\n  } catch (error) {\n    uni.hideLoading();\n    uni.showToast({\n      title: error.message || '添加失败',\n      icon: 'none'\n    });\n    console.error('添加商品失败:', error);\n    \n    // 如果失败了，也要检查登录状态是否被清除\n    const adminLoginStatus = uni.getStorageSync('admin_login_status');\n    if (adminLoginStatus !== 'loggedin') {\n      console.warn('添加商品失败后检测到登录状态丢失，重新设置');\n      uni.setStorageSync('admin_login_status', 'loggedin');\n      uni.setStorageSync('admin_id', 'admin');\n    }\n  }\n};\n</script>\n\n<style>\n.container {\n  min-height: 100vh;\n  background-color: #f8f9fa;\n  width: 100vw;\n  box-sizing: border-box;\n  position: relative;\n  overflow-x: hidden;\n}\n\n.header {\n  position: sticky;\n  top: 0;\n  z-index: 100;\n  background-color: #ffffff;\n  width: 100%;\n  box-sizing: border-box;\n}\n\n.form-wrapper {\n  padding-bottom: 80px;\n  width: 100%;\n  box-sizing: border-box;\n}\n\n.form-item {\n  margin-bottom: 16px;\n  width: 100%;\n  padding-left: 16px;\n  padding-right: 16px;\n  box-sizing: border-box;\n  position: relative;\n}\n\n.form-label {\n  font-size: 14px;\n  color: #333;\n  font-weight: 500;\n}\n\n.form-input-wrapper {\n  background-color: #ffffff;\n  border-radius: 8px;\n  padding: 12px;\n}\n\n.form-input, .form-textarea {\n  width: 100%;\n  padding: 12px;\n  background-color: #ffffff;\n  border-radius: 8px;\n  font-size: 14px;\n  min-height: 44px;\n  box-sizing: border-box;\n}\n\n.pl-0 {\n  padding-left: 0;\n}\n\n.image-upload-container {\n  background-color: white;\n  border-radius: 8px;\n  padding: 16px;\n  width: 100%;\n  box-sizing: border-box;\n}\n\n.image-upload-label {\n  font-size: 14px;\n  color: #333;\n  margin-bottom: 12px;\n  font-weight: 500;\n}\n\n.image-upload-area {\n  width: 100%;\n  height: 200px;\n  border: 1px dashed #ddd;\n  border-radius: 8px;\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  overflow: hidden;\n  box-sizing: border-box;\n}\n\n.upload-placeholder {\n  display: flex;\n  flex-direction: column;\n  align-items: center;\n  color: #999;\n}\n\n.upload-text {\n  margin-top: 8px;\n  font-size: 14px;\n}\n\n.mb-2 {\n  margin-bottom: 8px;\n}\n\n.mb-1 {\n  margin-bottom: 4px;\n}\n\n.preview-image {\n  width: 100%;\n  height: 100%;\n  object-fit: contain;\n}\n\n.picker-content {\n  background-color: #ffffff;\n  padding: 12px;\n  border-radius: 8px;\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n  box-sizing: border-box;\n}\n\n.picker-text {\n  color: #333;\n}\n\n.mr-2 {\n  margin-right: 8px;\n}\n\n.publish-btn {\n  border: none;\n  min-width: 70px;\n  line-height: 1.8;\n}\n\n/* 工具类 */\n.bg-white { background-color: #ffffff; }\n.bg-green-500 { background-color: #4CAF50; }\n.bg-gray-300 { background-color: #d1d5db; }\n.text-white { color: #ffffff; }\n.text-gray-500 { color: #6b7280; }\n.text-gray-600 { color: #4b5563; }\n.text-gray-900 { color: #111827; }\n.text-lg { font-size: 18px; }\n.text-sm { font-size: 14px; }\n.font-medium { font-weight: 500; }\n.flex { display: flex; }\n.flex-1 { flex: 1; }\n.items-center { align-items: center; }\n.w-full { width: 100%; }\n.p-3 { padding: 12px; }\n.p-4 { padding: 16px; }\n.px-4 { padding-left: 16px; padding-right: 16px; }\n.py-1 { padding-top: 4px; padding-bottom: 4px; }\n.pt-10 { padding-top: 40px; }\n.pb-3 { padding-bottom: 12px; }\n.mb-4 { margin-bottom: 16px; }\n.rounded-lg { border-radius: 8px; }\n.rounded-full { border-radius: 9999px; }\n.text-center { text-align: center; }\n</style> ","import MiniProgramPage from 'D:/Documents/HBuilderProjects/CarbonFootprint/pages/admin/reward-add.vue'\nwx.createPage(MiniProgramPage)"],"names":["ref","uni","onLoad","onShow","computed","addReward","MiniProgramPage"],"mappings":"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"}