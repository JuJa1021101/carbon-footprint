{"version":3,"file":"reward-list.js","sources":["pages/admin/reward-list.vue","../../../Software/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvYWRtaW4vcmV3YXJkLWxpc3QudnVl"],"sourcesContent":["<template>\n  <view class=\"container\">\n    <!-- 顶部导航栏 -->\n    <view class=\"header bg-green px-4 py-3\">\n      <view class=\"flex items-center\">\n        <view @tap=\"goBack\" class=\"p-2\">\n          <IconImage name=\"back\" :size=\"18\" class=\"back-icon\" />\n        </view>\n        <view class=\"flex-1 text-center\">\n          <text class=\"text-white text-lg font-medium\">积分商城奖品管理</text>\n        </view>\n        <view class=\"w-24px\"></view> <!-- 为了居中标题的占位 -->\n      </view>\n    </view>\n    \n    <!-- 加载状态 -->\n    <view v-if=\"loading\" class=\"loading-container py-10\">\n      <view class=\"loading-spinner\"></view>\n      <text class=\"loading-text\">加载中...</text>\n    </view>\n    \n    <!-- 内容区 -->\n    <view v-else class=\"p-4\">\n      <!-- 商品数量统计 -->\n      <view class=\"stats-bar mb-4\">\n        <text class=\"stats-text\">共 {{ rewards.length }} 个商品</text>\n      </view>\n      \n      <!-- 无商品提示 -->\n      <view v-if=\"rewards.length === 0\" class=\"empty-container\">\n        <text class=\"empty-text\">暂无商品，点击\"添加\"按钮创建新商品</text>\n      </view>\n      \n      <!-- 商品列表 -->\n      <view v-else class=\"reward-list\">\n        <view \n          v-for=\"reward in rewards\" \n          :key=\"reward._id\"\n          class=\"reward-item\"\n          @tap=\"navigateToEdit(reward._id)\">\n          <view class=\"reward-header\">\n            <text class=\"reward-title\">{{ reward.name }}</text>\n            <view class=\"more-btn\" @tap.stop=\"showDeleteOption(reward)\">\n              <IconImage name=\"more\" :size=\"16\" />\n            </view>\n          </view>\n          \n          <view class=\"reward-content\">\n            <view class=\"reward-image-container\">\n              <image :src=\"formatImageUrl(reward.image_url)\" class=\"reward-image\" mode=\"aspectFill\" @error=\"handleImageError($event, reward)\" />\n            </view>\n            <view class=\"reward-info\">\n              <view class=\"info-item\">\n                <text class=\"info-label\">库存:</text>\n                <text class=\"info-text\">{{ reward.stock_quantity || reward.stock || 0 }}</text>\n              </view>\n              <view class=\"info-item\">\n                <text class=\"info-label\">分类:</text>\n                <text class=\"info-text\">{{ getCategoryText(reward.category) }}</text>\n              </view>\n              <view class=\"info-item\">\n                <text class=\"info-label\">积分:</text>\n                <text class=\"info-text\">{{ reward.required_points || reward.points || 0 }}</text>\n              </view>\n            </view>\n          </view>\n          \n          <view class=\"reward-footer\">\n            <view class=\"tag\" v-if=\"reward.is_hot\">热门</view>\n            <view class=\"tag\" v-if=\"reward.is_limited || reward.is_limited_time\">限时</view>\n          </view>\n        </view>\n      </view>\n    </view>\n    \n    <!-- 悬浮添加按钮 -->\n    <view class=\"float-btn\" @tap=\"navigateToAdd\">\n      <view class=\"float-btn-inner\">\n        <text class=\"plus-text\">+</text>\n      </view>\n    </view>\n  </view>\n</template>\n\n<script setup>\nimport { ref, onMounted } from 'vue';\nimport { onShow, onLoad, onUnload } from '@dcloudio/uni-app';\nimport { getAllRewards, deleteReward, getRewardCount } from '../../services/mall.js';\nimport IconImage from '../../components/IconImage.vue';\n\n// 商品列表\nconst rewards = ref([]);\nconst loading = ref(true);\n\n// 格式化图片URL，确保路径正确\nconst formatImageUrl = (url) => {\n  if (!url) return '/static/images/mall/default-product.png';\n  \n  // 如果不是以斜杠或http开头，添加前导斜杠\n  if (!url.startsWith('/') && !url.startsWith('http')) {\n    return '/' + url;\n  }\n  \n  return url;\n};\n\n// 处理图片加载错误\nconst handleImageError = (e, reward) => {\n  console.error(`商品[${reward.name}]图片加载失败:`, e);\n  e.target.src = '/static/images/mall/default-product.png';\n};\n\n// 获取分类显示文字\nconst getCategoryText = (category) => {\n  const categories = {\n    'daily': '日常用品',\n    'plant': '绿植花卉',\n    'coupon': '优惠券'\n  };\n  return categories[category] || category;\n};\n\n// 获取商品列表\nconst loadRewards = async () => {\n  loading.value = true;\n  try {\n    const result = await getAllRewards();\n    \n    // 按照优先级排序：限时商品 > 热门商品 > 普通商品\n    rewards.value = result.sort((a, b) => {\n      // 限时商品排在最前面\n      if ((a.is_limited === true || a.is_limited_time === true) && \n          (b.is_limited !== true && b.is_limited_time !== true)) {\n        return -1;\n      }\n      if ((a.is_limited !== true && a.is_limited_time !== true) && \n          (b.is_limited === true || b.is_limited_time === true)) {\n        return 1;\n      }\n      \n      // 热门商品排在其次\n      if (a.is_hot === true && b.is_hot !== true) {\n        return -1;\n      }\n      if (a.is_hot !== true && b.is_hot === true) {\n        return 1;\n      }\n      \n      // 默认按照创建时间倒序\n      const aTime = a.created_at || 0;\n      const bTime = b.created_at || 0;\n      return bTime - aTime;\n    });\n    \n    // 更新dashboard页面上显示的商品数量\n    updateRewardCount(rewards.value.length);\n    \n  } catch (error) {\n    console.error('获取商品列表失败:', error);\n    uni.showToast({\n      title: error.message || '获取商品列表失败',\n      icon: 'none'\n    });\n  } finally {\n    loading.value = false;\n  }\n};\n\n// 更新商品数量缓存，用于dashboard页面显示\nconst updateRewardCount = (count) => {\n  uni.setStorageSync('reward_count', count);\n};\n\n// 返回上一页\nconst goBack = () => {\n  uni.navigateBack();\n};\n\n// 跳转到添加商品页面\nconst navigateToAdd = () => {\n  uni.navigateTo({\n    url: '/pages/admin/reward-add'\n  });\n};\n\n// 跳转到编辑商品页面\nconst navigateToEdit = (rewardId) => {\n  uni.navigateTo({\n    url: `/pages/admin/reward-edit?id=${rewardId}`\n  });\n};\n\n// 显示删除选项\nconst showDeleteOption = (reward) => {\n  uni.showActionSheet({\n    itemList: ['删除'],\n    itemColor: '#ff0000',\n    success: (res) => {\n      if (res.tapIndex === 0) {\n        confirmDeleteReward(reward);\n      }\n    }\n  });\n};\n\n// 确认删除商品\nconst confirmDeleteReward = (reward) => {\n  uni.showModal({\n    title: '确认删除',\n    content: `确定要删除\"${reward.name}\"商品吗？删除后无法恢复。`,\n    confirmColor: '#ff0000',\n    success: (res) => {\n      if (res.confirm) {\n        handleDeleteReward(reward._id);\n      }\n    }\n  });\n};\n\n// 删除商品\nconst handleDeleteReward = async (rewardId) => {\n  try {\n    await deleteReward(rewardId);\n    rewards.value = rewards.value.filter(reward => reward._id !== rewardId);\n    \n    // 更新商品数量\n    updateRewardCount(rewards.value.length);\n    \n    uni.showToast({\n      title: '删除成功',\n      icon: 'success'\n    });\n  } catch (error) {\n    uni.showToast({\n      title: error.message || '删除失败',\n      icon: 'none'\n    });\n  }\n};\n\n// 处理商品更新事件\nconst handleRewardsUpdate = (eventData) => {\n  console.log('收到商品更新事件:', eventData);\n  loadRewards(); // 刷新商品列表\n  \n  // 显示操作成功提示\n  let message = '';\n  switch(eventData.type) {\n    case 'add':\n      message = '商品添加成功';\n      break;\n    case 'update':\n      message = '商品更新成功';\n      break;\n    case 'delete':\n      message = '商品删除成功';\n      break;\n    default:\n      message = '商品信息已更新';\n  }\n  \n  uni.showToast({\n    title: message,\n    icon: 'success',\n    duration: 2000\n  });\n};\n\n// 页面加载\nonMounted(() => {\n  // 检查管理员登录状态\n  const adminLoginStatus = uni.getStorageSync('admin_login_status');\n  if (adminLoginStatus !== 'loggedin') {\n    console.log('管理员未登录，跳转到登录页面');\n    uni.showToast({\n      title: '请先登录',\n      icon: 'none'\n    });\n    setTimeout(() => {\n      uni.reLaunch({\n        url: '/pages/admin/login'\n      });\n    }, 1500);\n    return;\n  }\n  \n  loadRewards();\n});\n\n// 每次显示页面时刷新列表\nonShow(() => {\n  console.log('商品列表页面显示，检查登录状态');\n  \n  // 确保每次显示时都验证登录状态\n  const adminLoginStatus = uni.getStorageSync('admin_login_status');\n  if (adminLoginStatus !== 'loggedin') {\n    console.log('检测到管理员未登录，跳转到登录页面');\n    uni.showToast({\n      title: '请先登录',\n      icon: 'none'\n    });\n    setTimeout(() => {\n      uni.reLaunch({\n        url: '/pages/admin/login'\n      });\n    }, 1500);\n    return;\n  }\n  \n  // 无论如何都刷新列表，确保添加商品后能显示\n  loadRewards();\n  \n  // 检查是否有添加或编辑操作的提示\n  const actionMessage = uni.getStorageSync('reward_action_message');\n  if (actionMessage) {\n    // 显示提示\n    uni.showToast({\n      title: actionMessage,\n      icon: 'success'\n    });\n    // 使用后清除\n    uni.removeStorageSync('reward_action_message');\n  }\n});\n\n// 监听页面加载和卸载\nonLoad(() => {\n  // 监听商品更新事件，以便刷新列表\n  uni.$on('rewardsUpdated', handleRewardsUpdate);\n});\n\nonUnload(() => {\n  // 清除事件监听\n  uni.$off('rewardsUpdated');\n});\n</script>\n\n<style>\n.container {\n  min-height: 100vh;\n  background-color: #f8f9fa;\n}\n\n.header {\n  padding-top: 44px;\n  padding-bottom: 12px;\n  box-sizing: content-box;\n}\n\n.bg-green {\n  background-color: #4CAF50;\n}\n\n.back-icon {\n  width: 18px;\n  height: 18px;\n}\n\n.stats-bar {\n  background-color: #fff;\n  padding: 12px 16px;\n  border-radius: 8px;\n  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);\n}\n\n.stats-text {\n  font-size: 14px;\n  color: #666;\n}\n\n.mb-4 {\n  margin-bottom: 16px;\n}\n\n.icon-size {\n  width: 16px;\n  height: 16px;\n}\n\n.float-btn {\n  position: fixed;\n  bottom: 80px;\n  right: 20px;\n  width: 50px;\n  height: 50px;\n  z-index: 100;\n}\n\n.float-btn-inner {\n  width: 50px;\n  height: 50px;\n  border-radius: 25px;\n  background-color: #4CAF50;\n  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  color: white;\n  font-size: 24px;\n}\n\n.plus-text {\n  color: white;\n  font-size: 30px;\n  font-weight: bold;\n  line-height: 30px;\n  text-align: center;\n  margin-top: -2px; /* 轻微上移调整垂直位置 */\n}\n\n.empty-container {\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  height: 200px;\n}\n\n.empty-text {\n  color: #999;\n  font-size: 14px;\n}\n\n.reward-list {\n  display: flex;\n  flex-direction: column;\n  gap: 16px;\n}\n\n.reward-item {\n  background-color: #fff;\n  border-radius: 12px;\n  padding: 16px;\n  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);\n}\n\n.reward-header {\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n  margin-bottom: 12px;\n}\n\n.reward-title {\n  font-size: 16px;\n  font-weight: 600;\n  color: #333;\n}\n\n.more-btn {\n  width: 30px;\n  height: 30px;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n}\n\n.reward-content {\n  display: flex;\n  margin-bottom: 12px;\n}\n\n.reward-image-container {\n  width: 80px;\n  height: 80px;\n  margin-right: 12px;\n  overflow: hidden;\n  border-radius: 8px;\n}\n\n.reward-image {\n  width: 100%;\n  height: 100%;\n  object-fit: cover;\n}\n\n.reward-info {\n  flex: 1;\n  display: flex;\n  flex-direction: column;\n  justify-content: center;\n}\n\n.info-item {\n  display: flex;\n  font-size: 14px;\n  margin-bottom: 4px;\n}\n\n.info-label {\n  color: #666;\n  margin-right: 6px;\n}\n\n.info-text {\n  color: #333;\n}\n\n.reward-footer {\n  display: flex;\n  gap: 8px;\n}\n\n.tag {\n  background-color: #f0f0f0;\n  color: #666;\n  font-size: 12px;\n  padding: 2px 8px;\n  border-radius: 12px;\n}\n\n.tag:first-child {\n  background-color: #ffebee;\n  color: #e57373;\n}\n\n.tag:nth-child(2) {\n  background-color: #e8f5e9;\n  color: #81c784;\n}\n\n/* 加载动画 */\n.loading-container {\n  display: flex;\n  flex-direction: column;\n  align-items: center;\n  justify-content: center;\n  height: 200px;\n}\n\n.loading-spinner {\n  width: 36px;\n  height: 36px;\n  border: 3px solid #e0e0e0;\n  border-top-color: #4CAF50;\n  border-radius: 50%;\n  animation: spin 0.8s linear infinite;\n  margin-bottom: 12px;\n}\n\n.loading-text {\n  color: #666;\n  font-size: 14px;\n}\n\n@keyframes spin {\n  to { transform: rotate(360deg); }\n}\n\n/* 工具类 */\n.flex { display: flex; }\n.flex-1 { flex: 1; }\n.items-center { align-items: center; }\n.justify-center { justify-content: center; }\n.text-center { text-align: center; }\n.text-white { color: #ffffff; }\n.text-lg { font-size: 18px; }\n</style> ","import MiniProgramPage from 'D:/Documents/HBuilderProjects/CarbonFootprint/pages/admin/reward-list.vue'\nwx.createPage(MiniProgramPage)"],"names":["ref","uni","getAllRewards","deleteReward","onMounted","onShow","onLoad","onUnload","MiniProgramPage"],"mappings":"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"}