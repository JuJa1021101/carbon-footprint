{"version":3,"file":"checkin.js","sources":["pages/checkin/checkin.vue","../../../Software/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvY2hlY2tpbi9jaGVja2luLnZ1ZQ"],"sourcesContent":["<template>\n  <view class=\"container\">\n    <!-- 顶部导航栏 -->\n    <view class=\"px-4 pt-10 pb-4 bg-white\">\n      <view class=\"flex items-center justify-between mb-4\">\n        <text class=\"text-xl font-bold\">环保打卡</text>\n        <view class=\"relative\">\n          <text class=\"iconfont icon-history text-gray-500\"></text>\n          <text class=\"badge-dot\">3</text>\n        </view>\n      </view>\n    </view>\n\n    <!-- 环保积分状态 -->\n    <view class=\"p-4 bg-white\">\n      <view class=\"flex items-center justify-between mb-4\">\n        <view>\n          <text class=\"text-sm text-gray-500\">我的环保积分</text>\n          <view class=\"flex items-baseline\">\n            <text class=\"text-3xl font-bold mr-2\">{{ userPoints }}</text>\n            <text class=\"text-xs text-red-500\">+{{ todayPoints }}</text>\n          </view>\n        </view>\n        <view class=\"bg-green-50 text-green-600 px-3 py-1 rounded-full text-xs\">\n          {{ userLevel }}\n        </view>\n      </view>\n\n      <view class=\"mb-2\">\n        <view class=\"flex justify-between text-sm mb-1\">\n          <text>升级进度</text>\n          <text class=\"text-green-500\">{{ userPoints }}/{{ nextLevelPoints }}</text>\n        </view>\n        <view class=\"progress-bar\">\n          <view class=\"progress\" :style=\"{ width: progressWidth + '%' }\"></view>\n        </view>\n      </view>\n      <text class=\"text-xs text-gray-500\">再获得{{ pointsNeeded }}积分即可升级到{{ nextLevel }}</text>\n    </view>\n\n    <!-- 标签筛选 -->\n    <view class=\"px-4 py-3 bg-white border-b mt-2\">\n      <view class=\"flex justify-around\">\n        <view class=\"tab-btn active font-medium\">\n          <text>行为打卡</text>\n          <view class=\"tab-indicator\"></view>\n        </view>\n        <view class=\"tab-btn text-gray-500\">我的记录</view>\n      </view>\n    </view>\n\n    <!-- 打卡选项 -->\n    <view class=\"p-4\">\n      <text class=\"text-lg font-semibold mb-4\">今日可打卡项目</text>\n\n      <!-- 垃圾分类打卡项 -->\n      <view class=\"card bg-white shadow-sm mb-4\">\n        <view class=\"p-4 flex\">\n          <view class=\"badge-large mr-4\">\n            <text class=\"iconfont icon-trash text-2xl\"></text>\n            <text class=\"text-xs mt-1\">+5分</text>\n          </view>\n          <view class=\"flex-grow\">\n            <text class=\"font-medium mb-1\">垃圾分类打卡</text>\n            <text class=\"text-sm text-gray-500 mb-2\">拍照上传今日垃圾分类情况</text>\n            <view class=\"flex\">\n              <text class=\"tag\">日常任务</text>\n              <text class=\"tag space-left\">每日一次</text>\n            </view>\n          </view>\n          <button class=\"btn-checkin text-sm self-center\" @tap=\"handleCheckin(5, '垃圾分类')\">打卡</button>\n        </view>\n      </view>\n\n      <!-- 资源回收打卡项 -->\n      <view class=\"card bg-white shadow-sm mb-4\">\n        <view class=\"p-4 flex\">\n          <view class=\"badge-large mr-4\">\n            <text class=\"iconfont icon-recycle text-2xl\"></text>\n            <text class=\"text-xs mt-1\">+10分</text>\n          </view>\n          <view class=\"flex-grow\">\n            <text class=\"font-medium mb-1\">资源回收打卡</text>\n            <text class=\"text-sm text-gray-500 mb-2\">可回收物品(纸箱、塑料瓶等)回收</text>\n            <view class=\"flex\">\n              <text class=\"tag\">进阶任务</text>\n              <text class=\"tag space-left\">每周三次</text>\n            </view>\n          </view>\n          <button class=\"btn-checkin text-sm self-center\" @tap=\"handleCheckin(10, '资源回收')\">打卡</button>\n        </view>\n      </view>\n\n      <!-- 低碳出行打卡项 -->\n      <view class=\"card bg-white shadow-sm mb-4\">\n        <view class=\"p-4 flex\">\n          <view class=\"badge-large mr-4\">\n            <text class=\"iconfont icon-bicycle text-2xl\"></text>\n            <text class=\"text-xs mt-1\">+15分</text>\n          </view>\n          <view class=\"flex-grow\">\n            <text class=\"font-medium mb-1\">低碳出行打卡</text>\n            <text class=\"text-sm text-gray-500 mb-2\">选择步行、自行车或公共交通出行</text>\n            <view class=\"flex\">\n              <text class=\"tag\">进阶任务</text>\n              <text class=\"tag space-left\">每日一次</text>\n            </view>\n          </view>\n          <button class=\"btn-checkin-outline text-sm self-center\">已打卡</button>\n        </view>\n      </view>\n\n      <!-- 节能减排打卡项 -->\n      <view class=\"card bg-white shadow-sm mb-4\">\n        <view class=\"p-4 flex\">\n          <view class=\"badge-large-disabled mr-4\">\n            <text class=\"iconfont icon-bolt text-2xl\"></text>\n            <text class=\"text-xs mt-1\">+8分</text>\n          </view>\n          <view class=\"flex-grow\">\n            <text class=\"font-medium text-gray-400 mb-1\">节能减排打卡</text>\n            <text class=\"text-sm text-gray-400 mb-2\">一小时不使用电器，节约用电</text>\n            <view class=\"flex\">\n              <text class=\"tag-disabled\">日常任务</text>\n              <text class=\"tag-disabled space-left\">每日一次</text>\n            </view>\n          </view>\n          <text class=\"text-xs text-gray-400 self-center\">明日可打卡</text>\n        </view>\n      </view>\n\n      <!-- 查看更多按钮 -->\n      <view class=\"text-center mt-6\">\n        <button class=\"text-green-500 border border-green-500 rounded-full px-6 py-2 text-sm\">\n          查看更多打卡项目\n          <text class=\"iconfont icon-down ml-1\"></text>\n        </button>\n      </view>\n    </view>\n  </view>\n</template>\n\n<script setup>\nimport { ref, computed, onMounted, onBeforeUnmount } from 'vue';\nimport { getUserPoints, updatePointsCache } from '../../services/points.js';\n\n// 用户积分\nconst userPoints = ref(300);\nconst todayPoints = ref(15);\n\n// 用户等级信息\nconst userLevelInfo = {\n  1: { name: '环保新手 Lv.1', nextLevel: '环保学徒Lv.2', threshold: 100 },\n  2: { name: '环保学徒 Lv.2', nextLevel: '环保达人Lv.3', threshold: 300 },\n  3: { name: '环保达人 Lv.3', nextLevel: '环保先锋Lv.4', threshold: 500 },\n  4: { name: '环保先锋 Lv.4', nextLevel: '环保大使Lv.5', threshold: 800 },\n  5: { name: '环保大使 Lv.5', nextLevel: '环保使者Lv.6', threshold: 1200 }\n};\n\n// 计算当前等级\nconst currentLevel = computed(() => {\n  if (userPoints.value < 100) return 1;\n  if (userPoints.value < 300) return 2;\n  if (userPoints.value < 500) return 3;\n  if (userPoints.value < 800) return 4;\n  return 5;\n});\n\n// 用户等级显示\nconst userLevel = computed(() => {\n  return userLevelInfo[currentLevel.value].name;\n});\n\n// 下一等级名称\nconst nextLevel = computed(() => {\n  return userLevelInfo[currentLevel.value].nextLevel;\n});\n\n// 下一等级所需积分\nconst nextLevelPoints = computed(() => {\n  return userLevelInfo[currentLevel.value].threshold;\n});\n\n// 升级还需积分\nconst pointsNeeded = computed(() => {\n  return Math.max(0, nextLevelPoints.value - userPoints.value);\n});\n\n// 进度条宽度百分比\nconst progressWidth = computed(() => {\n  // 当前等级的起始积分\n  let startPoints = 0;\n  if (currentLevel.value > 1) {\n    startPoints = userLevelInfo[currentLevel.value - 1].threshold;\n  }\n  \n  // 计算在当前等级内的进度百分比\n  const levelRange = nextLevelPoints.value - startPoints;\n  const currentProgress = userPoints.value - startPoints;\n  return Math.min(100, Math.max(0, (currentProgress / levelRange) * 100));\n});\n\n// 初始化数据\nonMounted(async () => {\n  // 加载用户积分\n  await loadUserPoints();\n  \n  // 监听积分更新事件\n  uni.$on('userPointsUpdated', handlePointsUpdate);\n});\n\nonBeforeUnmount(() => {\n  // 组件销毁前移除事件监听\n  uni.$off('userPointsUpdated', handlePointsUpdate);\n});\n\n// 加载用户积分\nconst loadUserPoints = async () => {\n  try {\n    const result = await getUserPoints(true); // 强制刷新\n    if (result && result.success && result.data) {\n      userPoints.value = result.data.points;\n      console.log('打卡页面更新积分:', userPoints.value);\n    }\n  } catch (error) {\n    console.error('获取积分失败:', error);\n  }\n};\n\n// 监听积分更新事件\nconst handlePointsUpdate = (pointsData) => {\n  if (pointsData && typeof pointsData.points !== 'undefined') {\n    console.log('打卡页面收到积分更新事件:', pointsData);\n    userPoints.value = pointsData.points;\n  }\n};\n\n// 处理打卡\nconst handleCheckin = async (points, type) => {\n  try {\n    uni.showLoading({ title: '正在打卡...' });\n    \n    // 模拟API调用延迟\n    await new Promise(resolve => setTimeout(resolve, 1500));\n    \n    // 更新今日获取的积分\n    todayPoints.value += points;\n    \n    // 调用积分更新云函数\n    const { result } = await uniCloud.callFunction({\n      name: 'updateUserPoints',\n      data: {\n        userId: '10086420', // 使用固定的默认用户ID\n        pointsChange: points,\n        reason: `${type}打卡`\n      }\n    });\n    \n    uni.hideLoading();\n    \n    if (result && result.success) {\n      console.log('打卡成功，积分更新结果:', result);\n      \n      // 使用云函数返回的积分值更新本地显示\n      if (result.data && result.data.current_points !== undefined) {\n        const newPoints = result.data.current_points;\n    userPoints.value = newPoints;\n    \n    // 更新积分缓存，这会自动广播到其他页面\n    updatePointsCache({ points: newPoints });\n    \n        // 更新本地存储中的积分\n        try {\n          uni.setStorageSync('user_points', newPoints.toString());\n          console.log('打卡后更新本地积分存储:', newPoints);\n        } catch (e) {\n          console.error('保存积分到本地存储失败:', e);\n        }\n      }\n      \n    uni.showToast({\n      title: '打卡成功',\n      icon: 'success'\n    });\n    } else {\n      console.error('打卡失败，积分更新失败:', result);\n      uni.showToast({\n        title: '打卡失败，请重试',\n        icon: 'none'\n      });\n    }\n  } catch (error) {\n    uni.hideLoading();\n    console.error('打卡失败:', error);\n    uni.showToast({\n      title: '打卡失败，请重试',\n      icon: 'none'\n    });\n  }\n};\n</script>\n\n<style>\n.container {\n  background-color: #f8f9fa;\n  font-family: \"PingFang SC\", \"Helvetica Neue\", Arial, sans-serif;\n  color: #333;\n  padding-bottom: 80px;\n}\n\n.card {\n  border-radius: 16px;\n  overflow: hidden;\n}\n\n.badge-large {\n  width: 72px;\n  height: 72px;\n  border-radius: 16px;\n  display: flex;\n  flex-direction: column;\n  align-items: center;\n  justify-content: center;\n  background-color: #f1f9f2;\n  color: #4CAF50;\n}\n\n.badge-large-disabled {\n  width: 72px;\n  height: 72px;\n  border-radius: 16px;\n  display: flex;\n  flex-direction: column;\n  align-items: center;\n  justify-content: center;\n  background-color: #f3f4f6;\n  color: #9ca3af;\n}\n\n.badge-dot {\n  position: absolute;\n  top: -4px;\n  right: -4px;\n  width: 16px;\n  height: 16px;\n  background-color: #ef4444;\n  border-radius: 50%;\n  color: white;\n  font-size: 10px;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n}\n\n.progress-bar {\n  height: 6px;\n  border-radius: 3px;\n  background-color: #e9ecef;\n  overflow: hidden;\n}\n\n.progress {\n  height: 100%;\n  border-radius: 3px;\n  background-color: #4CAF50;\n}\n\n.tab-btn {\n  position: relative;\n  padding-bottom: 10px;\n}\n\n.tab-indicator {\n  position: absolute;\n  bottom: 0;\n  left: 50%;\n  transform: translateX(-50%);\n  width: 20px;\n  height: 3px;\n  background-color: #4CAF50;\n  border-radius: 3px;\n}\n\n.btn-checkin {\n  background-color: #4CAF50;\n  color: white;\n  border-radius: 24px;\n  padding: 12px 32px;\n  font-weight: 600;\n}\n\n.btn-checkin-outline {\n  border: 1px solid #4CAF50;\n  color: #4CAF50;\n  border-radius: 24px;\n  padding: 12px 24px;\n  font-weight: 600;\n  background-color: white;\n}\n\n.tag {\n  background-color: rgba(76, 175, 80, 0.1);\n  color: #4CAF50;\n  border-radius: 12px;\n  padding: 2px 10px;\n  font-size: 12px;\n  display: inline-block;\n}\n\n.tag-disabled {\n  background-color: #f3f4f6;\n  color: #9ca3af;\n  border-radius: 12px;\n  padding: 2px 10px;\n  font-size: 12px;\n  display: inline-block;\n}\n\n.space-left {\n  margin-left: 8px;\n}\n\n/* 工具类 */\n.px-4 { padding-left: 16px; padding-right: 16px; }\n.pt-10 { padding-top: 40px; }\n.pb-4 { padding-bottom: 16px; }\n.py-3 { padding-top: 12px; padding-bottom: 12px; }\n.p-4 { padding: 16px; }\n.px-3 { padding-left: 12px; padding-right: 12px; }\n.py-1 { padding-top: 4px; padding-bottom: 4px; }\n.px-6 { padding-left: 24px; padding-right: 24px; }\n.py-2 { padding-top: 8px; padding-bottom: 8px; }\n\n.mb-4 { margin-bottom: 16px; }\n.mb-3 { margin-bottom: 12px; }\n.mb-2 { margin-bottom: 8px; }\n.mb-1 { margin-bottom: 4px; }\n.mr-4 { margin-right: 16px; }\n.mr-2 { margin-right: 8px; }\n.mr-1 { margin-right: 4px; }\n.ml-auto { margin-left: auto; }\n.ml-1 { margin-left: 4px; }\n.mt-6 { margin-top: 24px; }\n.mt-2 { margin-top: 8px; }\n.mt-1 { margin-top: 4px; }\n\n.bg-white { background-color: #ffffff; }\n.bg-gray-100 { background-color: #f3f4f6; }\n.bg-green-50 { background-color: #f0fdf4; }\n\n.text-3xl { font-size: 30px; }\n.text-2xl { font-size: 24px; }\n.text-xl { font-size: 20px; }\n.text-lg { font-size: 18px; }\n.text-sm { font-size: 14px; }\n.text-xs { font-size: 12px; }\n\n.font-bold { font-weight: 700; }\n.font-semibold { font-weight: 600; }\n.font-medium { font-weight: 500; }\n\n.text-gray-400 { color: #9ca3af; }\n.text-gray-500 { color: #6b7280; }\n.text-green-500 { color: #4CAF50; }\n.text-green-600 { color: #4CAF50; }\n.text-red-500 { color: #ef4444; }\n.text-white { color: #ffffff; }\n\n.flex { display: flex; }\n.flex-grow { flex-grow: 1; }\n.flex-col { flex-direction: column; }\n.items-center { align-items: center; }\n.items-baseline { align-items: baseline; }\n.justify-between { justify-content: space-between; }\n.justify-around { justify-content: space-around; }\n.justify-center { justify-content: center; }\n.self-center { align-self: center; }\n\n.border-b { border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: #e5e7eb; }\n.border { border-width: 1px; border-style: solid; }\n.border-green-500 { border-color: #4CAF50; }\n\n.rounded-full { border-radius: 9999px; }\n.rounded-lg { border-radius: 8px; }\n\n.shadow-sm { box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }\n\n.relative { position: relative; }\n.absolute { position: absolute; }\n.top-0 { top: 0; }\n.right-0 { right: 0; }\n</style> ","import MiniProgramPage from 'D:/Documents/HBuilderProjects/CarbonFootprint/pages/checkin/checkin.vue'\nwx.createPage(MiniProgramPage)"],"names":["ref","computed","onMounted","uni","onBeforeUnmount","getUserPoints","uniCloud","updatePointsCache","MiniProgramPage"],"mappings":"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"}